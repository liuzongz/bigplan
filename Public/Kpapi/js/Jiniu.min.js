/**
 * Created by K on 15-7-13.
 */

var Jiniu = {
    ajax : function(url, params, callback, transferMode, responseType, asyn){
        transferMode = typeof(transferMode) === "string" && transferMode.toUpperCase() === "GET" ? "GET" : "POST";
        if (transferMode === "GET")  {
            var d = new Date();
            url += params ? (url.indexOf("?") === - 1 ? "?" : "&") + params : "";
            //url = encodeURI(url) + (url.indexOf("?") === - 1 ? "?" : "&") + d.getTime() + d.getMilliseconds();
            params = null;
        }
        responseType = typeof(responseType) === "string" && ((responseType = responseType.toUpperCase()) === "JSON" || responseType === "XML") ? responseType : "TEXT";
        asyn = ((asyn === false) ? false : true);
        return $.ajax({
            url:url,
            dataType:responseType.toLowerCase(),
            type:transferMode,
            data:params,
            success:function(data){
                if (typeof(callback) === "function")  {
                    callback(data);
                }
                return data;
            },
            error:function(ex){
                alert(ex);
            },
            async:asyn
        });
    },
    selectSpec : function(message, goods_id, parent){
        var html = '';
        if (message.length > 0) {
            for (var s in message) {
                var k = message[s];
                var input_type = 'radio';
                var li = '<li class="info_li genre" data-attr_type="' + k.attr_type + '" data-spec="spec_' + k.attr_id + '"></li>';
                var spec = '';
                if (k.attr_type == 1) {
                    input_type = 'radio';
                } else {
                    input_type = 'checkbox';
                }
                for (var ss in k.values) {
                    var l = k.values[ss];
                    var specs = '',current = '';
                    if (ss == 0 && k.attr_type == 1) current = ' current';
                    specs += '<div class="sbox border left' + current + '">';
                    specs += '<input type="checkbox" name="spec_' + k.attr_id + '" value="' +l.id +'" id="spec_' + k.attr_id + '_' + l.id + '" />';
                    specs += '<label for="spec_' + k.attr_id + '_' + l.id + '" data-id="' + l.id + '" data-price="' + l.price + '">' + l.label+ '</label>';
                    specs += '</div>';
                    spec += specs;
                }
                var lis = $(li).append('<div class="titl left">' + k.name + '</div><div class="conte left" data-attr_type="' + k.attr_type + '">' + spec + '</div>');
                html += $($(li).append(lis)).html();
            }
            var btn = '<a class="selectspecbtn right" href="javascript:void(0);">确定</a>';
            lis = $(li).append('<div class="titl left"></div><div class="conte left" data-attr_type="' + k.attr_type + '">' + btn + '</div>');
            html += $($(li).append(lis)).html();
            html = '<ul class="info_ul">' + html + '</ul>';
        }
        this.msgbox(html,'请选择产品属性','0','500','300');
        //this.openDiv('请选择产品属性！','4324231');

    },
    msgbox : function (str, title, icon, width, height, closebtn){  /*新建一个弹出层*/
        closebtn = closebtn ? true : false;//alert(width + '=' + height);return;
        var that = this,
            time = new Date().getTime(),
            msgtype = msgtype,
            icon = icon ? icon : '',
            title = title ? title : '汇客惠品',
            scWidth =  $(document).width() || window.innerWidth
                || document.documentElement.clientWidth
                || document.body.clientWidth,//window.screen.width,
            scHeight =  $(document).height() || window.innerHeight
                || document.documentElement.clientHeight
                || document.body.clientHeight ,//window.screen.height;
            box_bg = document.createElement('div'),
            box_bg_id = "msgbox_bg_" + time,
            box_id = "msgbox_" + time,
            isIE6 = !!window.ActiveXObject&&!window.XMLHttpRequest,
            contents_height = !isNaN(height) ? (height - 69) + 'px' : 'auto',//padding+title.height=69;
            str = str ? str : '<div class="loading" style="height:' + (contents_height) + 'px">&nbsp;</div>';
        if(isIE6){
            alert('本功能不支持IE6内核浏览器，请更换浏览器后重试！');return false;
        }
        $(box_bg).attr({'id':box_bg_id,'class':'msgbox_bg'}).css({'width':scWidth + "px",'height':scHeight + "px"});
        $('body').append(box_bg);
        width = that.getworh(width,400);
        height = that.getworh(height,300);
        var box = document.createElement('div');
        $(box).attr({'id':box_id,'class':'msgbox'}).css({'width':width,'height':height});
        $('body').append(box);

        var str = '<div class="padding"><div class="msgbox_title"><i class="Left icon">' + icon + '</i><h3 class="Left title">' + title + '</h3><span class="close Right" style="float:right;"> X </span></div><div class="msgbox_contents" style="overflow:hidden;height:' + contents_height + '">' + str + '</div></div>';
        $('#' + box_id).html(str);
        $(box).html(str).css({'top':"200px",'left': (scWidth - $('#' + box_id).width())/2 + "px"});
        this.close_msgbox = that.close = function (){
            $('#' + box_bg_id).remove();
            $('#' + box_id).remove();
        }
        if(!closebtn){
            $('#' + box_bg_id).bind('click',that.close);
            $('#' + box_id + " span.close").bind('click',that.close);
        }
        return $('#' + box_id);
    },
    getworh : function ($size,$default){
        if ($size == 'auto') {
            result = 'auto';
        } else if (this.checkNumber($size)) {
            result = $size + "px";
        } else if (this.checkInStr($size,"%")) {
            result = $size;
        } else {
            result = $default + "px";
        }
        return result;
    },
    checkEmail : function(str){
        var re = /^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(.[a-zA-Z0-9_-])+/;///^(\w-*\.*)+@(\w-?)+(\.\w{2,})+$/
        return (re.test(str));
    },
    checkUser : function (str){
        var re = /^[a-zA-Z0-9_]{6,15}$/;
        return (re.test(str));
    },
    checkMobile : function (str) {
        var re = /^1[3|4|5|7|8]?\d{9}$/
        return (re.test(str));
    },
    checkPhone : function (str){
        var re = /^0\d{2,3}-?\d{7,8}$/;
        return re.test(str);
    },
    checkNumber : function(str) {
        var re = /^\d$/;
        return re.test(str);
    },
    checkInStr : function(Str,instr) {
        try {
            return Str.indexOf(instr);
        } catch ($e) {
            return false;
        }

    },
    rand : function(len){
        var str = "1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
        if(len < 2) len = 1;
        var tmp = "";
        for(var i=0;i < len;i++) {
            tmp += str.charAt(Math.ceil(Math.random()*100000000) % str.length);
        }
        return	tmp;
    },
    createImgBase64: function (img, file, $w) {
        if (Jiniu.browser.webkit) {
            //Chrome8+
            img.src = window.webkitURL.createObjectURL(file);
        } else if (browser.gecko) {
            //FF4+
            img.src = window.URL.createObjectURL(file);
        } else {
            //实例化file reader对象
            var reader = new FileReader();
            reader.onload = function (e) {
                img.src = this.result;
                $w.append(img);
            };
            reader.readAsDataURL(file);
        }
    },
    IsPC : function () {
        var userAgentInfo = navigator.userAgent;
        var Agents = ["Android", "iPhone", "SymbianOS", "Windows Phone","iPad", "iPod"];
        var flag = true;
        for (var v = 0; v < Agents.length; v++) {
            if (userAgentInfo.indexOf(Agents[v]) > 0) {
                flag = false;
                break;
            }
        }
        return flag;
    },
    loading : function (){
        $img = '/Public/Kpapi/images/loading.gif';
        Jiniu.msgbox('<div class="loading"><img src="' + $img + '" /></div>','加载中...','','50%','auto');
    },
    alert : function ($str,$title) {
        Jiniu.msgbox('<div class="alert">' + $str + '</div>',$title,'','60%','auto');
    },
    confirm : function($str) {

    },
    show : function($str,$title) {
        Jiniu.msgbox($str,$title,'','80%','auto');
    }
}

var browser = Jiniu.browser = function(){
    var agent = navigator.userAgent.toLowerCase(),
        opera = window.opera,
        browser = {
            /**
             * @property {boolean} ie 检测当前浏览器是否为IE
             * @example
             * ```javascript
             * if ( UE.browser.ie ) {
         *     console.log( '当前浏览器是IE' );
         * }
             * ```
             */
            ie		:  /(msie\s|trident.*rv:)([\w.]+)/.test(agent),

            /**
             * @property {boolean} opera 检测当前浏览器是否为Opera
             * @example
             * ```javascript
             * if ( UE.browser.opera ) {
         *     console.log( '当前浏览器是Opera' );
         * }
             * ```
             */
            opera	: ( !!opera && opera.version ),

            /**
             * @property {boolean} webkit 检测当前浏览器是否是webkit内核的浏览器
             * @example
             * ```javascript
             * if ( UE.browser.webkit ) {
         *     console.log( '当前浏览器是webkit内核浏览器' );
         * }
             * ```
             */
            webkit	: ( agent.indexOf( ' applewebkit/' ) > -1 ),

            /**
             * @property {boolean} mac 检测当前浏览器是否是运行在mac平台下
             * @example
             * ```javascript
             * if ( UE.browser.mac ) {
         *     console.log( '当前浏览器运行在mac平台下' );
         * }
             * ```
             */
            mac	: ( agent.indexOf( 'macintosh' ) > -1 ),

            /**
             * @property {boolean} quirks 检测当前浏览器是否处于“怪异模式”下
             * @example
             * ```javascript
             * if ( UE.browser.quirks ) {
         *     console.log( '当前浏览器运行处于“怪异模式”' );
         * }
             * ```
             */
            quirks : ( document.compatMode == 'BackCompat' )
        };

    /**
     * @property {boolean} gecko 检测当前浏览器内核是否是gecko内核
     * @example
     * ```javascript
     * if ( UE.browser.gecko ) {
    *     console.log( '当前浏览器内核是gecko内核' );
    * }
     * ```
     */
    browser.gecko =( navigator.product == 'Gecko' && !browser.webkit && !browser.opera && !browser.ie);

    var version = 0;

    // Internet Explorer 6.0+
    if ( browser.ie ){


        var v1 =  agent.match(/(?:msie\s([\w.]+))/);
        var v2 = agent.match(/(?:trident.*rv:([\w.]+))/);
        if(v1 && v2 && v1[1] && v2[1]){
            version = Math.max(v1[1]*1,v2[1]*1);
        }else if(v1 && v1[1]){
            version = v1[1]*1;
        }else if(v2 && v2[1]){
            version = v2[1]*1;
        }else{
            version = 0;
        }

        browser.ie11Compat = document.documentMode == 11;
        /**
         * @property { boolean } ie9Compat 检测浏览器模式是否为 IE9 兼容模式
         * @warning 如果浏览器不是IE， 则该值为undefined
         * @example
         * ```javascript
         * if ( UE.browser.ie9Compat ) {
         *     console.log( '当前浏览器运行在IE9兼容模式下' );
         * }
         * ```
         */
        browser.ie9Compat = document.documentMode == 9;

        /**
         * @property { boolean } ie8 检测浏览器是否是IE8浏览器
         * @warning 如果浏览器不是IE， 则该值为undefined
         * @example
         * ```javascript
         * if ( UE.browser.ie8 ) {
         *     console.log( '当前浏览器是IE8浏览器' );
         * }
         * ```
         */
        browser.ie8 = !!document.documentMode;

        /**
         * @property { boolean } ie8Compat 检测浏览器模式是否为 IE8 兼容模式
         * @warning 如果浏览器不是IE， 则该值为undefined
         * @example
         * ```javascript
         * if ( UE.browser.ie8Compat ) {
         *     console.log( '当前浏览器运行在IE8兼容模式下' );
         * }
         * ```
         */
        browser.ie8Compat = document.documentMode == 8;

        /**
         * @property { boolean } ie7Compat 检测浏览器模式是否为 IE7 兼容模式
         * @warning 如果浏览器不是IE， 则该值为undefined
         * @example
         * ```javascript
         * if ( UE.browser.ie7Compat ) {
         *     console.log( '当前浏览器运行在IE7兼容模式下' );
         * }
         * ```
         */
        browser.ie7Compat = ( ( version == 7 && !document.documentMode )
            || document.documentMode == 7 );

        /**
         * @property { boolean } ie6Compat 检测浏览器模式是否为 IE6 模式 或者怪异模式
         * @warning 如果浏览器不是IE， 则该值为undefined
         * @example
         * ```javascript
         * if ( UE.browser.ie6Compat ) {
         *     console.log( '当前浏览器运行在IE6模式或者怪异模式下' );
         * }
         * ```
         */
        browser.ie6Compat = ( version < 7 || browser.quirks );

        browser.ie9above = version > 8;

        browser.ie9below = version < 9;

    }

    // Gecko.
    if ( browser.gecko ){
        var geckoRelease = agent.match( /rv:([\d\.]+)/ );
        if ( geckoRelease )
        {
            geckoRelease = geckoRelease[1].split( '.' );
            version = geckoRelease[0] * 10000 + ( geckoRelease[1] || 0 ) * 100 + ( geckoRelease[2] || 0 ) * 1;
        }
    }

    /**
     * @property { Number } chrome 检测当前浏览器是否为Chrome, 如果是，则返回Chrome的大版本号
     * @warning 如果浏览器不是chrome， 则该值为undefined
     * @example
     * ```javascript
     * if ( UE.browser.chrome ) {
     *     console.log( '当前浏览器是Chrome' );
     * }
     * ```
     */
    if (/chrome\/(\d+\.\d)/i.test(agent)) {
        browser.chrome = + RegExp['\x241'];
    }

    /**
     * @property { Number } safari 检测当前浏览器是否为Safari, 如果是，则返回Safari的大版本号
     * @warning 如果浏览器不是safari， 则该值为undefined
     * @example
     * ```javascript
     * if ( UE.browser.safari ) {
     *     console.log( '当前浏览器是Safari' );
     * }
     * ```
     */
    if(/(\d+\.\d)?(?:\.\d)?\s+safari\/?(\d+\.\d+)?/i.test(agent) && !/chrome/i.test(agent)){
        browser.safari = + (RegExp['\x241'] || RegExp['\x242']);
    }


    // Opera 9.50+
    if ( browser.opera )
        version = parseFloat( opera.version() );

    // WebKit 522+ (Safari 3+)
    if ( browser.webkit )
        version = parseFloat( agent.match( / applewebkit\/(\d+)/ )[1] );

    /**
     * @property { Number } version 检测当前浏览器版本号
     * @remind
     * <ul>
     *     <li>IE系列返回值为5,6,7,8,9,10等</li>
     *     <li>gecko系列会返回10900，158900等</li>
     *     <li>webkit系列会返回其build号 (如 522等)</li>
     * </ul>
     * @example
     * ```javascript
     * console.log( '当前浏览器版本号是： ' + UE.browser.version );
     * ```
     */
    browser.version = version;

    /**
     * @property { boolean } isCompatible 检测当前浏览器是否能够与UEditor良好兼容
     * @example
     * ```javascript
     * if ( UE.browser.isCompatible ) {
     *     console.log( '浏览器与UEditor能够良好兼容' );
     * }
     * ```
     */
    browser.isCompatible =
        !browser.mobile && (
            ( browser.ie && version >= 6 ) ||
                ( browser.gecko && version >= 10801 ) ||
                ( browser.opera && version >= 9.5 ) ||
                ( browser.air && version >= 1 ) ||
                ( browser.webkit && version >= 522 ) ||
                false );
    return browser;
}();


Jiniu.Sms = {
    Const : {
        url 		: 	'/sendmessage.php',
        boxID 		: 	'#JS_lightBox_',
        captchaID	:	'#_JS_sndSms_captcha_',
        expr_idID	:	'#_JS_sndSms_id_',
        mobileID	:	'#_JS_sndSms_input_',
        captchaImgID:	'#_JS_sndSms_captchaImg_',
        SendBtnID	:	'#_JS_sndSms_btn_',
        msgID		:	'#_JS_sndSms_msg_box_',
        conID		:	'#_JS_sndSms_content_',
        verify_img : 	'',
        mobileReg  :	/^(((13[0-9]{1})|159|153|155|152|158|(18[0-9]{1}))+\d{8})$/,
        resultStr 	: 	'',
        randStr 	: 	'',
        mobileMSG	:	'请输入有效的手机号码！',
        verMSG		:	'请输入验证码！',
        messageMSG	:	'无短信内容！',
        SendingMsg	:	'正在发送信息，请稍候...',
        close3Msg	:	' 本窗口3秒后自动关闭！'
    },
    SendSms : function(id, content){
        var that = this;
        K.Const.randStr = K.rand(8);
        K.ajax(K.Const.url,'id=' + id + '&content=' + content + '&rand=' + K.Const.randStr, that.cWindow,'','text');
    },
    cWindow : function(result){
        var resultStr = result;
        $('body').append(resultStr);
    },
    wClose : function(str){
        if(!str)str = K.Const.randStr;
        $(K.Const.boxID + str).remove();
    },
    setmsg : function(str,icon){
        if(icon){
            $(K.Const.msgID + ' span.icon').removeClass('no');
            $(K.Const.msgID + ' span.icon').addClass('ok');
        }else{
            $(K.Const.msgID + ' span.icon').removeClass('ok');
            $(K.Const.msgID + ' span.icon').addClass('no');
        }
        $(K.Const.msgID).css('display','block');
        $(K.Const.msgID + ' span.text').text(str);
    },
    sendMsg : function(){
        var url = 'expr.html';//K.Const.url + '?act=send_message';
        autoClose	= true;
        autoSend	= false;
        phoneNumber	= false;
        captcha		= $(K.Const.captchaID).val();
        expr_id		= $(K.Const.expr_idID).val();
        mobile		= $(K.Const.mobileID).val();
        type		= 'exprAddress'
        Sendurl		= "";
        content 	= $(K.Const.conID).val();
        var myreg = K.Const.mobileReg;
        K.Const.verify_img = $(K.Const.captchaImgID).attr('data-src');
        if(!myreg.test(mobile)){
            K.setmsg(K.Const.mobileMSG);
            $(K.Const.mobileID).focus();
            $(K.Const.captchaImgID).attr('src',K.Const.verify_img + "&rnd=" + new Date().getTime());
            return false;
        }else if( captcha == ''){
            K.setmsg(K.Const.verMSG);
            $(K.Const.captchaImgID).attr('src',K.Const.verify_img + "&rnd=" + new Date().getTime());
            return false;
        }/*else if(content == '' || content == 'undefined'){
         K.setmsg(K.Const.messageMSG);
         $(K.Const.captchaImgID).attr('src',K.Const.verify_img + "&rnd=" + new Date().getTime());
         return false;
         }*/
        $(K.Const.SendBtnID).attr('disabled','disabled');
        K.setmsg(K.Const.SendingMsg);
        var data = "autoClose=" + autoClose ;
        data += "&act=sendmsg";
        data += "&autoSend=" + autoSend ;
        data += "&captcha=" + captcha ;
        data += "&expr_id=" + expr_id ;
        data += "&mobile=" + mobile ;
        data += "&phoneNumber=" + phoneNumber ;
        data += "&type=" + type ;
        data += "&Sendurl=" + Sendurl ;
        data += "&content=" + content ;
        //K.SendSmsResult({error:0,message:'短信发送成功！'});
        K.ajax(url,data,K.SendSmsResult);
    },
    SendSmsResult : function (result){
        K.setmsg(result.message);
        if(result.error == 0){
            K.setmsg(result.message + K.Const.close3Msg,1);
            setTimeout(function(){K.wClose()}, 3000);
        }
        $(K.Const.SendBtnID).removeAttr('disabled');
        $(K.Const.captchaImgID).attr('src',K.Const.verify_img + "&rnd=" + new Date().getTime());
    },

    ajax : function(url,data,callback,parameters,datatype){
        if(datatype=='' || datatype==null)datatype='json';
        (data!="" && data!=null)?type="POST":type="GET";
        $.ajax({
            type:type,
            url:url,
            data:data,
            success:function(getdata){
                if(parameters!='' || parameters!=''){
                    callback(getdata,parameters);
                }else{
                    callback(getdata);
                }
            },
            error:function(e){
                K.setmsg("服务器连接失败！");
            },
            dataType:datatype
        });
    },
    rand : function(len){
        var str = "1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
        if(len < 2) len = 1;
        var tmp = "";
        for(var i=0;i < len;i++) {
            tmp += str.charAt(Math.ceil(Math.random()*100000000) % str.length);
        }
        return	tmp;
    }
}

Jiniu.passport = {
    init : function(box, $type){
        var obj = '';
        var that = Jiniu.passport;
        Jiniu.box = box;

        if ($type == 0) {
            obj = $('#JS_loginBtn', box);
            obj.val('登录');
            obj.bind('click', function(){that.login(box,this)});
            //$('#JS_mloginfrm').submit(function(){$('#JS_loginBtn', box).click()});
        } else {
            var tab = $('#JS_regType').find('input:checked');
            if (tab.val() == 0) {
                obj = $('#JS_registBtn', box);
                obj.val('立即注册');
                obj.unbind('clcik').bind('click', function(){that.register(box,this)});
            } else if (tab.val() == 1)  {
                obj = $('#JS_mregistBtn', box);
                obj.val('立即注册');
                obj.unbind('clcik').bind('click', function(){that.register(box,this)});
            } else {
                obj = $('#JS_registBtn', box);
                obj.val('立即注册');
                obj.unbind('clcik').bind('click', function(){that.register(box,this)});

                obj = $('#JS_mregistBtn', box);
                obj.val('立即注册');
                obj.unbind('clcik').bind('click', function(){that.register(box,this)});
                $('#JS_regType',box).find('input').get(0).click();
            }
            $('#JS_regType',box).find('input').attr('disabled',false);
        }
        obj.css('background','#ff4c4c');
        $('.input_text', box).bind('blur', function(){that.textblur(box, this)});
        that.regtype(box);
        that.getverify(box);
    },
    login : function(box,obj){
        $(obj).unbind('click');
        $(obj).val('正在登录....');
        $(obj).css('background','#ccc');
        var that = Jiniu.passport;
        var url = base_url + 'user.php?act=act_login';
        var loginbox    = $('.mlogin', box),
            user        = $('.username',loginbox),
            pass        = $('.password',loginbox),
            verify      = $('.verify',loginbox),
            autol       = $('.autologin',loginbox),
            back        = $('.backact',loginbox),
            autologin   = autol.checked ? 1 : 0;
        if (user.val() == '') {
            that.msg(user,1,'用户名不能为空！');
            that.init(box, 0);
        } else if ( pass.val().length < 6) {
            that.msg(pass,1,'密码不能小数6位数！');
            that.init(box, 0);
        } else if (verify.length > 0 && verify.val().length != 4) {
            that.msg(verify,1,'验证码输入错误！');
            that.init(box, 0);
        } else {
            var data = 'is_ajax=1';
            if (verify.length > 0) {
                data += '&captcha=' + verify.val();
            }
            data += '&username=' + user.val();
            data += '&password=' + pass.val();
            data += '&remember=' + autologin;
            data += '&back_act=' + back.val();
            Jiniu.ajax(url,data,that.loginResult,'POST','JSON');
        }
    },
    textblur : function(box,obj){
        Jiniu.passport.unmsg(box,obj);
    },
    loginResult : function(result){
        var that = Jiniu.passport;
        if (result.error != 0) {
            alert(result.message);
            that.init(Jiniu.box, 0);
        } else {
            if (result.lnk) {
                location.href = result.lnk;
            } else {
                location.reload();
            }
        }
    },
    getverify : function(box){
        var that = Jiniu.passport;
        var obj = $('#JS_nregist', box);
        var getv = function(){

        }
        $('#JS_getVer', obj).unbind('click').bind('click', function(){
            var tel = $('.mobile', obj).val()
            var ss = $(this);
            var str = '获取验证码';
            ss.unbind('click');
            if (!Jiniu.checkMobile(tel)) {
                that.msg($('.mobile', obj),1,'请输入正确的手机号码！');
                that.init(box, 1);
            } else {
                var time = 180;
                var data = 'tel=' + tel;
                var step = function(){
                    time = time - 1;
                    if (time > 0) {
                        ss.text(str + '(' + time + ')');
                        setTimeout(step,1000);
                    } else {
                        ss.text(str);
                        that.getverify(Jiniu.box);
                        time = 180;
                    }
                };
                var result = function(ex){
                    if (ex.error > 0) {
                        alert(ex.message);
                    } else {
                        alert(ex.message);
                        step();
                    }
                }
                Jiniu.ajax('/sendmessage.php?act=send', data, result, 'POST', 'JSON');
            }
        });
    },
    regtype : function(box){
        $('#JS_regType', box).find('input').bind('change', function(){
            var context = $(this).attr('data-context');
            box.find('ul.mregist').addClass('none');
            $(context,box).removeClass('none');
        });
    },
    register : function(box,obj){
        var btn = $(obj);
        var $typeobj = $('#JS_regType',box);
        var $type = $typeobj.find('input:checked').val();
        $typeobj.find('input').attr('disabled',true);
        btn.unbind();
        btn.val('正在提交注册....');
        btn.css('background','#ccc');
        var that = Jiniu.passport;
        if ($type === "0") {
            var registbox = $('#JS_mregist', box),
                userobj = $('.username', registbox),
                emailobj = $('.email', registbox),
                pass1obj = $('.pass1', registbox),
                pass2obj = $('.pass2', registbox),
                mobileobj = $('.mobile', registbox),
                protocolobj = $('.protocol', registbox),
                backobj = $('.backact', registbox);
            var user = userobj.val(),
                email = emailobj.val(),
                pass1 = pass1obj.val(),
                pass2 = pass2obj.val(),
                mobile = mobileobj.val(),
                protocol = (protocolobj.is(':checked') ? 1 : 0);
            if (!Jiniu.checkUser(user)) {
                that.msg(userobj,1,'用户名必须为字母加数字加下划线组合！');
                that.init(box, 1);
            } else if (!Jiniu.checkEmail(email)) {
                that.msg(emailobj,1,'请输入正确的Email地址！');
                that.init(box, 1);
            } else if (pass1.length < 6 || pass1.length > 18) {
                that.msg(pass1obj,1,'密码密码为6-18字符串！');
                that.init(box, 1);
            } else if (pass1 != pass2) {
                that.msg(pass2obj,1,'两次密码输入不一致！');
                that.init(box, 1);
            } else if (!Jiniu.checkMobile(mobile)) {
                that.msg(mobileobj,1,'请输入正确的手机号码！');
                that.init(box, 1);
            } else if (protocol != 1) {
                alert('同意美家家商城注册协议方可继续注册！');
                that.init(box, 1);
            } else {
                var url = base_url + 'user.php?act=act_register&is_ajax=1';
                var data = 'username=' + user;
                data += '&password=' + pass1;
                data += '&confirm_password=' + pass2;
                data += '&email=' + email;
                data += '&extend_field5=' + mobile;
                data += '&agreement=' + protocol;
                data += '&type=' + $type;
                data += '&back_act=' + backobj.val();
                Jiniu.ajax(url,data,that.registerResult,'POST','JSON');
            }
        } else {
            var registbox = $('#JS_nregist', box),
                mobileobj = $('.mobile', registbox),
                verifyobj = $('.verify', registbox),
                pass1obj = $('.password', registbox),
                pass2obj = $('.password1', registbox),
                userobj = $('.username', registbox),
                protocolobj = $('.protocol', registbox),
                backobj = $('.backact', registbox);
            var mobile = mobileobj.val(),
                verify = verifyobj.val(),
                pass1 = pass1obj.val(),
                pass2 = pass2obj.val(),
                user = userobj.val(),
                protocol = (protocolobj.is(':checked') ? 1 : 0);
            if (!Jiniu.checkMobile(mobile)) {
                that.msg(mobileobj,1,'请输入正确的手机号码！');
                that.init(box, 1);
            } else if (verify.length != 6) {
                that.msg(verifyobj,1,'请输入手机收到的验证码！');
                that.init(box, 1);
            } else if (pass1.length < 6 || pass1.length > 18) {
                that.msg(pass1obj,1,'密码密码为6-18字符串！');
                that.init(box, 1);
            } else if (pass1 != pass2) {
                that.msg(pass2obj,1,'两次密码输入不一致！');
                that.init(box, 1);
            } else if (protocol != 1) {
                alert('同意美家家商城注册协议方可继续注册！');
                that.init(box, 1);
            } else {
                var url = base_url + 'user.php?act=act_register&is_ajax=1';
                var data = 'username=' + mobile;
                data += '&verify=' + verify;
                data += '&password=' + pass1;
                data += '&confirm_password=' + pass2;
                data += '&email=' + email;
                data += '&type=' + $type;
                data += '&extend_field5=' + mobile;
                data += '&agreement=' + protocol;
                data += '&back_act=' + backobj.val();
                Jiniu.ajax(url,data,that.registerResult,'POST','JSON');
            }
            $typeobj.find('input').attr('disabled',false);
        }
    },
    registerResult : function(result){
        var box = this.box,
            that = Jiniu.passport;
        if (result.error > 0) {
            if (result.field) {
                that.msg($('.' + result.field, box),1,result.message);
            } else {
                alert(result.message);
            }
            that.init(Jiniu.box, 1);
        } else {
            if (result.lnk) {
                location.href = result.lnk;
            } else {
                location.href = '/';
            }
        }
        //Jiniu.passport.bindevent($('#JS_registBtn'), 1);
    },
    msg : function(obj, $type, $msg){
        obj.parent().children('.msg').text($msg);
        if ($type == 0) {
            $(obj).parent().addClass('success');
        } else {
            $(obj).parent().addClass('error');
        }
    },
    unmsg : function(box,obj){
        var o = $(obj,box).parent();
        if (o.hasClass('error')) {
            o.removeClass('error');
        }
        if (o.hasClass('success')) {
            o.removeClass('success');
        }
    }
}


Jiniu.login = function(){
    var that = this;
    var box = '';
    that.msgbox('','登录页面加载中.....');
    var loginResult = function(data){
        that.close_msgbox();
        box = that.msgbox(data,'用户登录','',400,500);
        that.passport.init(box, 0);
    };
    var url = base_url + 'user.php?act=mlogin';
    that.ajax(url, '', loginResult, 'POST', 'HTML');
}
Jiniu.regist = function(){
    var that = this;
    var box = '';
    that.msgbox('','注册页面加载中.....');
    var registResult = function(data){
        that.close_msgbox();
        box = that.msgbox(data,'用户注册','',400,560);
        that.passport.init(box, 1);
    };
    var url = base_url + 'user.php?act=mregister';
    that.ajax(url, '', registResult, 'POST', 'HTML');
}

Jiniu.getCartNum = function(){
    var url = '/flow.html?step=get_cart_num';
    var obj = $('#JS_top_Cart_num');
    var res = function(ex){
        if (ex.error > 0) {
            //alert(ex.message);
        } else {
            obj.text(ex.contents.goods_number);
        }
    };
    Jiniu.ajax(url,'id=', res, 'GET', 'JSON');
}