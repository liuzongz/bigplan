/**
 * Created by K on 15-7-13.
 */

var Jiniu = {
    ajax : function(url, params, callback, transferMode, responseType, asyn){
        transferMode = typeof(transferMode) === "string" && transferMode.toUpperCase() === "GET" ? "GET" : "POST";
        if (transferMode === "GET")  {
            var d = new Date();
            url += params ? (url.indexOf("?") === - 1 ? "?" : "&") + params : "";
            //url = encodeURI(url) + (url.indexOf("?") === - 1 ? "?" : "&") + d.getTime() + d.getMilliseconds();
            params = null;
        }
        responseType = typeof(responseType) === "string" && ((responseType = responseType.toUpperCase()) === "JSON" || responseType === "XML") ? responseType : "TEXT";
        asyn = ((asyn === false) ? false : true);
        return $.ajax({
            url:url,
            dataType:responseType.toLowerCase(),
            type:transferMode,
            data:params,
            success:function(data){
                if (typeof(callback) === "function")  {
                    callback(data);
                }
                return data;
            },
            error:function(ex){
                return ex;
            },
            async:asyn
        });
    },
    selectSpec : function(message, goods_id, parent){
        var html = '';
        if (message.length > 0) {
            for (var s in message) {
                var k = message[s];
                var input_type = 'radio';
                var li = '<li class="info_li genre" data-attr_type="' + k.attr_type + '" data-spec="spec_' + k.attr_id + '"></li>';
                var spec = '';
                if (k.attr_type == 1) {
                    input_type = 'radio';
                } else {
                    input_type = 'checkbox';
                }
                for (var ss in k.values) {
                    var l = k.values[ss];
                    var specs = '',current = '';
                    if (ss == 0 && k.attr_type == 1) current = ' current';
                    specs += '<div class="sbox border left' + current + '">';
                    specs += '<input type="checkbox" name="spec_' + k.attr_id + '" value="' +l.id +'" id="spec_' + k.attr_id + '_' + l.id + '" />';
                    specs += '<label for="spec_' + k.attr_id + '_' + l.id + '" data-id="' + l.id + '" data-price="' + l.price + '">' + l.label+ '</label>';
                    specs += '</div>';
                    spec += specs;
                }
                var lis = $(li).append('<div class="titl left">' + k.name + '</div><div class="conte left" data-attr_type="' + k.attr_type + '">' + spec + '</div>');
                html += $($(li).append(lis)).html();
            }
            var btn = '<a class="selectspecbtn right" href="javascript:void(0);">确定</a>';
            lis = $(li).append('<div class="titl left"></div><div class="conte left" data-attr_type="' + k.attr_type + '">' + btn + '</div>');
            html += $($(li).append(lis)).html();
            html = '<ul class="info_ul">' + html + '</ul>';
        }
        this.msgbox(html,'请选择产品属性','0','500','300');
        //this.openDiv('请选择产品属性！','4324231');

    },
    msgbox : function (str, title, icon, width, height, closebtn){  /*新建一个弹出层*/
        closebtn = closebtn ? true : false;//alert(width + '=' + height);return;
        var that = this,
            time = new Date().getTime(),
            msgtype = msgtype,
            icon = icon ? icon : '',
            title = title ? title : '汇客惠品',
            scWidth =  $(document).width() || window.innerWidth
                || document.documentElement.clientWidth
                || document.body.clientWidth,//window.screen.width,
            scHeight =  $(document).height() || window.innerHeight
                || document.documentElement.clientHeight
                || document.body.clientHeight ,//window.screen.height;
            box_bg = document.createElement('div'),
            box_bg_id = "msgbox_bg_" + time,
            box_id = "msgbox_" + time,
            isIE6 = !!window.ActiveXObject&&!window.XMLHttpRequest,
            contents_height = !isNaN(height) ? (height - 69) + 'px' : 'auto',//padding+title.height=69;
            str = str ? str : '<div class="loading" style="height:' + (contents_height) + 'px">&nbsp;</div>';
        if(isIE6){
            alert('本功能不支持IE6内核浏览器，请更换浏览器后重试！');return false;
        }
        $(box_bg).attr({'id':box_bg_id,'class':'msgbox_bg'}).css({'width':scWidth + "px",'height':scHeight + "px"});
        $('body').append(box_bg);
        width = that.getworh(width,400);
        height = that.getworh(height,300);
        var box = document.createElement('div');
        $(box).attr({'id':box_id,'class':'msgbox'}).css({'width':width,'height':height});
        $('body').append(box);

        var str = '<div class="padding"><div class="msgbox_title"><i class="Left icon">' + icon + '</i><h3 class="Left title">' + title + '</h3><span class="close Right" style="float:right;"> X </span></div><div class="msgbox_contents" style="overflow:hidden;height:' + contents_height + '">' + str + '</div></div>';
        $('#' + box_id).html(str);
        $(box).html(str).css({'top':"200px",'left': (scWidth - $('#' + box_id).width())/2 + "px"});
        this.close_msgbox = that.close = function (){
            $('#' + box_bg_id).remove();
            $('#' + box_id).remove();
        }
        if(!closebtn){
            $('#' + box_bg_id).bind('click',that.close);
            $('#' + box_id + " span.close").bind('click',that.close);
        }
        return $('#' + box_id);
    },
    getworh : function ($size,$default){
        if ($size == 'auto') {
            result = 'auto';
        } else if (this.checkNumber($size)) {
            result = $size + "px";
        } else if (this.checkInStr($size,"%")) {
            result = $size;
        } else {
            result = $default + "px";
        }
        return result;
    },
    checkEmail : function(str){
        var re = /^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(.[a-zA-Z0-9_-])+/;///^(\w-*\.*)+@(\w-?)+(\.\w{2,})+$/
        return (re.test(str));
    },
    checkUser : function (str){
        var re = /^[a-zA-Z0-9_]{6,15}$/;
        return (re.test(str));
    },
    checkMobile : function (str) {
        var re = /^1[3|4|5|7|8]?\d{9}$/
        return (re.test(str));
    },
    checkPhone : function (str){
        var re = /^0\d{2,3}-?\d{7,8}$/;
        return re.test(str);
    },
    checkNumber : function(str) {
        var re = /^\d$/;
        return re.test(str);
    },
    checkInStr : function(Str,instr) {
        try {
            return Str.indexOf(instr);
        } catch ($e) {
            return false;
        }

    },
    rand : function(len){
        var str = "1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
        if(len < 2) len = 1;
        var tmp = "";
        for(var i=0;i < len;i++) {
            tmp += str.charAt(Math.ceil(Math.random()*100000000) % str.length);
        }
        return	tmp;
    },
    createImgBase64: function (img, file, $w) {
        if (Jiniu.browser.webkit) {
            //Chrome8+
            img.src = window.webkitURL.createObjectURL(file);
        } else if (browser.gecko) {
            //FF4+
            img.src = window.URL.createObjectURL(file);
        } else {
            //实例化file reader对象
            var reader = new FileReader();
            reader.onload = function (e) {
                img.src = this.result;
                $w.append(img);
            };
            reader.readAsDataURL(file);
        }
    },
    IsPC : function () {
        var userAgentInfo = navigator.userAgent;
        var Agents = ["Android", "iPhone", "SymbianOS", "Windows Phone","iPad", "iPod"];
        var flag = true;
        for (var v = 0; v < Agents.length; v++) {
            if (userAgentInfo.indexOf(Agents[v]) > 0) {
                flag = false;
                break;
            }
        }
        return flag;
    },
    loading : function (){
        $img = '/Public/Wap/images/loading111.gif';
        var box = Jiniu.msgbox('<div class="loading"><img src="' + $img + '" /></div>','','','50%','auto');
        return box;
    },
    alert : function ($str,$title) {
        Jiniu.msgbox('<div class="alert">' + $str + '</div>',$title,'','60%','auto');
    },
    confirm : function($str) {

    },
    show : function($str,$title) {
        Jiniu.msgbox($str,$title,'','80%','auto');
    }
}

var browser = Jiniu.browser = function(){
    var agent = navigator.userAgent.toLowerCase(),
        opera = window.opera,
        browser = {
            /**
             * @property {boolean} ie 检测当前浏览器是否为IE
             * @example
             * ```javascript
             * if ( UE.browser.ie ) {
         *     console.log( '当前浏览器是IE' );
         * }
             * ```
             */
            ie		:  /(msie\s|trident.*rv:)([\w.]+)/.test(agent),

            /**
             * @property {boolean} opera 检测当前浏览器是否为Opera
             * @example
             * ```javascript
             * if ( UE.browser.opera ) {
         *     console.log( '当前浏览器是Opera' );
         * }
             * ```
             */
            opera	: ( !!opera && opera.version ),

            /**
             * @property {boolean} webkit 检测当前浏览器是否是webkit内核的浏览器
             * @example
             * ```javascript
             * if ( UE.browser.webkit ) {
         *     console.log( '当前浏览器是webkit内核浏览器' );
         * }
             * ```
             */
            webkit	: ( agent.indexOf( ' applewebkit/' ) > -1 ),

            /**
             * @property {boolean} mac 检测当前浏览器是否是运行在mac平台下
             * @example
             * ```javascript
             * if ( UE.browser.mac ) {
         *     console.log( '当前浏览器运行在mac平台下' );
         * }
             * ```
             */
            mac	: ( agent.indexOf( 'macintosh' ) > -1 ),

            /**
             * @property {boolean} quirks 检测当前浏览器是否处于“怪异模式”下
             * @example
             * ```javascript
             * if ( UE.browser.quirks ) {
         *     console.log( '当前浏览器运行处于“怪异模式”' );
         * }
             * ```
             */
            quirks : ( document.compatMode == 'BackCompat' )
        };

    /**
     * @property {boolean} gecko 检测当前浏览器内核是否是gecko内核
     * @example
     * ```javascript
     * if ( UE.browser.gecko ) {
    *     console.log( '当前浏览器内核是gecko内核' );
    * }
     * ```
     */
    browser.gecko =( navigator.product == 'Gecko' && !browser.webkit && !browser.opera && !browser.ie);

    var version = 0;

    // Internet Explorer 6.0+
    if ( browser.ie ){


        var v1 =  agent.match(/(?:msie\s([\w.]+))/);
        var v2 = agent.match(/(?:trident.*rv:([\w.]+))/);
        if(v1 && v2 && v1[1] && v2[1]){
            version = Math.max(v1[1]*1,v2[1]*1);
        }else if(v1 && v1[1]){
            version = v1[1]*1;
        }else if(v2 && v2[1]){
            version = v2[1]*1;
        }else{
            version = 0;
        }

        browser.ie11Compat = document.documentMode == 11;
        /**
         * @property { boolean } ie9Compat 检测浏览器模式是否为 IE9 兼容模式
         * @warning 如果浏览器不是IE， 则该值为undefined
         * @example
         * ```javascript
         * if ( UE.browser.ie9Compat ) {
         *     console.log( '当前浏览器运行在IE9兼容模式下' );
         * }
         * ```
         */
        browser.ie9Compat = document.documentMode == 9;

        /**
         * @property { boolean } ie8 检测浏览器是否是IE8浏览器
         * @warning 如果浏览器不是IE， 则该值为undefined
         * @example
         * ```javascript
         * if ( UE.browser.ie8 ) {
         *     console.log( '当前浏览器是IE8浏览器' );
         * }
         * ```
         */
        browser.ie8 = !!document.documentMode;

        /**
         * @property { boolean } ie8Compat 检测浏览器模式是否为 IE8 兼容模式
         * @warning 如果浏览器不是IE， 则该值为undefined
         * @example
         * ```javascript
         * if ( UE.browser.ie8Compat ) {
         *     console.log( '当前浏览器运行在IE8兼容模式下' );
         * }
         * ```
         */
        browser.ie8Compat = document.documentMode == 8;

        /**
         * @property { boolean } ie7Compat 检测浏览器模式是否为 IE7 兼容模式
         * @warning 如果浏览器不是IE， 则该值为undefined
         * @example
         * ```javascript
         * if ( UE.browser.ie7Compat ) {
         *     console.log( '当前浏览器运行在IE7兼容模式下' );
         * }
         * ```
         */
        browser.ie7Compat = ( ( version == 7 && !document.documentMode )
        || document.documentMode == 7 );

        /**
         * @property { boolean } ie6Compat 检测浏览器模式是否为 IE6 模式 或者怪异模式
         * @warning 如果浏览器不是IE， 则该值为undefined
         * @example
         * ```javascript
         * if ( UE.browser.ie6Compat ) {
         *     console.log( '当前浏览器运行在IE6模式或者怪异模式下' );
         * }
         * ```
         */
        browser.ie6Compat = ( version < 7 || browser.quirks );

        browser.ie9above = version > 8;

        browser.ie9below = version < 9;

    }

    // Gecko.
    if ( browser.gecko ){
        var geckoRelease = agent.match( /rv:([\d\.]+)/ );
        if ( geckoRelease )
        {
            geckoRelease = geckoRelease[1].split( '.' );
            version = geckoRelease[0] * 10000 + ( geckoRelease[1] || 0 ) * 100 + ( geckoRelease[2] || 0 ) * 1;
        }
    }

    /**
     * @property { Number } chrome 检测当前浏览器是否为Chrome, 如果是，则返回Chrome的大版本号
     * @warning 如果浏览器不是chrome， 则该值为undefined
     * @example
     * ```javascript
     * if ( UE.browser.chrome ) {
     *     console.log( '当前浏览器是Chrome' );
     * }
     * ```
     */
    if (/chrome\/(\d+\.\d)/i.test(agent)) {
        browser.chrome = + RegExp['\x241'];
    }

    /**
     * @property { Number } safari 检测当前浏览器是否为Safari, 如果是，则返回Safari的大版本号
     * @warning 如果浏览器不是safari， 则该值为undefined
     * @example
     * ```javascript
     * if ( UE.browser.safari ) {
     *     console.log( '当前浏览器是Safari' );
     * }
     * ```
     */
    if(/(\d+\.\d)?(?:\.\d)?\s+safari\/?(\d+\.\d+)?/i.test(agent) && !/chrome/i.test(agent)){
        browser.safari = + (RegExp['\x241'] || RegExp['\x242']);
    }


    // Opera 9.50+
    if ( browser.opera )
        version = parseFloat( opera.version() );

    // WebKit 522+ (Safari 3+)
    if ( browser.webkit )
        version = parseFloat( agent.match( / applewebkit\/(\d+)/ )[1] );

    /**
     * @property { Number } version 检测当前浏览器版本号
     * @remind
     * <ul>
     *     <li>IE系列返回值为5,6,7,8,9,10等</li>
     *     <li>gecko系列会返回10900，158900等</li>
     *     <li>webkit系列会返回其build号 (如 522等)</li>
     * </ul>
     * @example
     * ```javascript
     * console.log( '当前浏览器版本号是： ' + UE.browser.version );
     * ```
     */
    browser.version = version;

    /**
     * @property { boolean } isCompatible 检测当前浏览器是否能够与UEditor良好兼容
     * @example
     * ```javascript
     * if ( UE.browser.isCompatible ) {
     *     console.log( '浏览器与UEditor能够良好兼容' );
     * }
     * ```
     */
    browser.isCompatible =
        !browser.mobile && (
        ( browser.ie && version >= 6 ) ||
        ( browser.gecko && version >= 10801 ) ||
        ( browser.opera && version >= 9.5 ) ||
        ( browser.air && version >= 1 ) ||
        ( browser.webkit && version >= 522 ) ||
        false );
    return browser;
}();


window.WebApp = window.WebApp || {};
WebApp.html = {
    'loading':'<div class="loading"><{text}></div>',
    'error':'<div class="page_msg"><{text}></div>'
};
WebApp.ajax = function(url, params, callback,$obj, $data){
    var transferMode,responseType,asyn,that = this;
    transferMode = typeof($data.transferMode) != "undefined" && $data.transferMode.toUpperCase() === "GET" ? "GET" : "POST";
    if (transferMode === "GET")  {
        var d = new Date();
        url += params ? (url.indexOf("?") === - 1 ? "?" : "&") + params : "";
        //url = encodeURI(url) + (url.indexOf("?") === - 1 ? "?" : "&") + d.getTime() + d.getMilliseconds();
        params = null;
    }
    responseType = typeof($data.responseType) === "string" && ((responseType = $data.responseType.toUpperCase()) === "JSON" || responseType === "XML") ? responseType : "TEXT";
    asyn = $data.asyn === false ? false : true;
    return $.ajax({
        url:url,
        dataType:responseType.toLowerCase(),
        type:transferMode,
        data:params,
        success:function(data){
            if (typeof(callback) === "function")  {
                callback(data);
            }
            return data;
        },
        error:function(){
            $obj.html(that.View('error',{'text':'加载失败。。。<br/><br/><a href="">重新加载</a>'}));
        },
        timeout : function(){
            $obj.html(that.View('error',{'text':'网络不给力<br/><br/><a href="">重新加载</a>'}));
        },
        async:asyn
    });
};
WebApp.get = function($url, $obj, $body){
    var that = this;
    $obj.html(that.View('loading',{'text':'玩命加载中...'}));
    that.ajax($url, $body, function(ex){
        if (ex.error != 200) {
            that.showMsg(ex.msg);
            $obj.html(that.View('error',{'text':ex.data}));
        } else {
            $obj.html(ex.data);
        }
    },$obj,{transferMode:'POST',responseType:'JSON',asyn:true});
};
WebApp.showMsg = function($msg){
    alert($msg);
};
WebApp.View = function($tpl,$data) {
    var str = this.html[$tpl],left_label = '<{',right_label = '}>';
    for (var $key in $data) {
        var reg = new RegExp(left_label + $key + right_label, 'ig');
        str = str.replace(reg, $data[$key]);
    }
    return str;
};
WebApp.sleep = function(msec){
    var now = new Date();
    var exitTime = now.getTime() + msec;
    while (true) {
        now = new Date();
        if (now.getTime() > exitTime)
            return;
    }
}
WebApp.loadJS = function(xyUrl, callback){
    var head = document.getElementsByTagName('head')[0];
    var script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = '/Public/Wap/js/' + xyUrl + '.js';
    script.onload = script.onreadystatechange = function(){
        if((!this.readyState || this.readyState === "loaded" || this.readyState === "complete")){
            callback && callback();
            script.onload = script.onreadystatechange = null;
            if ( head && script.parentNode ) {
                head.removeChild( script );
            }
        }
    };
    head.insertBefore( script, head.firstChild );
};
WebApp.Widget = function(){
    var that = this;
    that.slide = function ($obj, $cfg){        //卡盘
        if (!$($cfg['content'])) return ;
        var run = function(){
            var bullets = $($cfg['content'], $obj).children();
            var nav = $($cfg['navCls'], $obj);
            var banner = Swipe($obj, {
                auto: $cfg['auto'] > 0 ? $cfg['auto'] : 0,
                continuous: $cfg['continuous'] ? $cfg['continuous'] : true,
                disableScroll: $cfg['disableScroll'] ? $cfg['disableScroll'] : false,
                content : $($cfg['content'], $obj),
                callback: function(pos) {
                    //console.log($('.cur',nav).length);
                    $('.cur',nav).removeClass('cur');
                    nav.children().eq(pos).addClass('cur');
                }
            });
        };
        if (typeof(Swipe) == "undefined") {
            that.loadJS('swipe',run);
        } else {
            run();
        }
    };
    that.Countdown = function ($obj, $cfg){      //倒计时
        if ($cfg['time'] == '') return;
        var act_endtime = $cfg['time'] ? $cfg['time'] : new Date().getTime();//活动结束时间
        var ss = $cfg['eobj'] ? $($cfg['eobj'],$obj) : '';
        var down = function(){
            var now_time = new Date().getTime();
            var end_time = act_endtime * 1000;
            var h ,m,s ,w;
            var t = end_time - now_time;
            //console.log(w);
            if (t > 0) {
                h = checkTime(Math.floor(t / 1000 / 60 / 60));
                m = checkTime(Math.floor(t / 1000 / 60 % 60));
                s = checkTime(Math.floor(t / 1000 % 60));
                w = checkTime(Math.floor(t / 10 % 100));
                function checkTime(i) {
                    if (i < 10) {
                        i = "0" + i;
                    }
                    return i;
                }
                $($cfg['Hobj'],$obj).text(h);
                $($cfg['Mobj'],$obj).text(m);
                $($cfg['Sobj'],$obj).text(s);
                if (ss) ss.text(w) ;
            }else if(t <= 0){
                clearInterval(si);
                $($cfg['Hobj'],$obj).text('00');
                $($cfg['Mobj'],$obj).text('00');
                $($cfg['Sobj'],$obj).text('00');
                if (ss) ss.text('00') ;
                //var callback = $cfg['callback'];
                $cfg['callback'] && $cfg['callback']();
            }
        } ;//down();
        var si = setInterval(down,10);
    };
    that.scroll_load = function($obj, $cfg){
        if ($cfg['url'] == '') return;
        //if (!$cfg['obj'])  return;
        var scroll_obj = $cfg['obj'] ? $cfg['obj'] : $(window);
        var show_status = $($cfg['show_status'], $obj);
        var show_box = $($cfg['show_box'], $obj);
        var asny = ($cfg['asny'] == true ? true : false);
        var page = 1,is_Querystring = function(url){
            string = url.split('/');
            url = string[string.length - 1];
            if(url.indexOf("?") != -1){
                return true;
            } else {
                return false;
            }
        },get_prev = function($sObj){
            $sObj.unbind('scroll');
            if(page >1)  show_status.html('<span><img src="/Public/Wap/images/loading1.gif" /></span><span>加载中....</span>');

            Jiniu.ajax($cfg['url'] + page,'',function(ex){ //+ (is_Querystring($cfg['url']) ? "&" : "?") + $cfg['page_name'] + "="
                if (ex.error == 200) {
                    page = parseInt(ex.data.curpage) + 1;
                    show_box.append(ex.data.str);
                    if (page > ex.data.pagecount) {
                        show_status.text('后面没有了！');
                    }else if(ex.data.str == ''&& page == 1){
                        show_status.removeClass('list_botton').addClass('page_msg').text('店主很懒，什么都没有留下！');
                    }else {
                        $sObj.bind('scroll',scroll);
                        show_status.text('上拉加载更多！');
                    }
                } else {
                    show_status.text(ex.msg);
                }
            },'POST','JSON', asny);
        }, getScroll = function($sObj){
            var htmlHeight = 0,clientHeight = 0,scrollTop = 0;
            if ($sObj[0] == window) {
                htmlHeight = document.documentElement.scrollHeight || document.body.scrollHeight;
                clientHeight = document.documentElement.clientHeight || document.body.clientHeight;
                scrollTop = document.body.scrollTop || document.documentElement.scrollTop;
            } else {
                htmlHeight = $sObj[0].scrollHeight;
                clientHeight = $sObj[0].offsetHeight;
                scrollTop = $sObj[0].scrollTop;
            }
            return {htmlHeight:htmlHeight,clientHeight:clientHeight,scrollTop:scrollTop};
        }, scroll = function(){
            var scroll_size = getScroll(scroll_obj);
            /*console.log('文本高度：'  + scroll_size.htmlHeight + "\n客户端高度：" + scroll_size.clientHeight + "\n已滚高度：" + scroll_size.scrollTop + "\nscrollTop + clientHeight = " + (scroll_size.scrollTop + scroll_size.clientHeight));*/
            if(scroll_size.scrollTop + scroll_size.clientHeight >= scroll_size.htmlHeight) {
                get_prev(scroll_obj);
            }
        };
        scroll_obj.bind('scroll',scroll);
        if ($cfg['star_load']) get_prev(scroll_obj);
    };
    var $list = $('.JNWidget');
    //console.log('查找到weight数量：' + $list.length);
    $list.each(function(index, item){
        var type = item.dataset['type'].toLowerCase();
        try{
            var cfg = eval('(' + item.dataset['cfg'] + ')');
            switch (type) {
                case 'slide': that.slide ($(this), cfg);break;
                case 'countdown': that.Countdown ($(this), cfg);break;
                case 'scroll': that.scroll_load ($(this), cfg);break;
            }
        } catch($e) {
            console.log('Widget运行错误，错误配置：' + item.dataset['cfg'] + "\n" + $e.message);
        }
    });
};
$(function(){
    WebApp.Widget()
});


WebApp.IpPos = function(){
    return 'aaaaa';
}
WebApp.Pos = WebApp.BMap = {};
WebApp.GpsPos = function(){
    var showSuccess = function (position){
        WebApp.Pos = {'error':0,'msg':'',data:{'lng':position.coords.longitude,'lat':position.coords.latitude}};
    };
    var ShowError = function (error){
        switch(error.code) {
            case error.PERMISSION_DENIED:
            case error.POSITION_UNAVAILABLE:
            case error.TIMEOUT:
            case error.UNKNOWN_ERROR:
                WebApp.Pos = {'error':1,'msg':'定位失败'};
        }
    };
    if(navigator.geolocation) {
        try {
            navigator.geolocation.getCurrentPosition(showSuccess, ShowError,{timeout:5000,enableHighAcuracy:true});
        } catch ($e) {
            ShowError();
        }
    } else {
        ShowError();
    }
}

WebApp.position = function (txt){
    txt.text('定位中..');
    WebApp.GpsPos();
    setTimeout(function(){
        if (WebApp.Pos.error === 0) {
            //txt.text('定位成功');
            WebApp.BaiduTranslte(WebApp.Pos.data.lng,WebApp.Pos.data.lat)
        } else {
            txt.text('定位失败');
        }
    },3000);
}

WebApp.BaiduTranslte = function(lat,lng){
    if (!BMap) return false;
    WebApp.ajax('http://api.map.baidu.com/ag/coord/convert?from=0&to=4&x=" + y + "&y=" + x + "','',function(ex){
        WebApp.toPoint(new BMap.Point(ex.x,ex.y));
    })
}
WebApp.toPoint = function(point){
    var myGeo = new BMap.Geocoder();
    myGeo.getLocation(point,function(ex) {
        alert(ex);
    })
}




















Jiniu.Sms = {
    Const : {
        url 		: 	'/sendmessage.php',
        boxID 		: 	'#JS_lightBox_',
        captchaID	:	'#_JS_sndSms_captcha_',
        expr_idID	:	'#_JS_sndSms_id_',
        mobileID	:	'#_JS_sndSms_input_',
        captchaImgID:	'#_JS_sndSms_captchaImg_',
        SendBtnID	:	'#_JS_sndSms_btn_',
        msgID		:	'#_JS_sndSms_msg_box_',
        conID		:	'#_JS_sndSms_content_',
        verify_img : 	'',
        mobileReg  :	/^(((13[0-9]{1})|159|153|155|152|158|(18[0-9]{1}))+\d{8})$/,
        resultStr 	: 	'',
        randStr 	: 	'',
        mobileMSG	:	'请输入有效的手机号码！',
        verMSG		:	'请输入验证码！',
        messageMSG	:	'无短信内容！',
        SendingMsg	:	'正在发送信息，请稍候...',
        close3Msg	:	' 本窗口3秒后自动关闭！'
    },
    SendSms : function(id, content){
        var that = this;
        K.Const.randStr = K.rand(8);
        K.ajax(K.Const.url,'id=' + id + '&content=' + content + '&rand=' + K.Const.randStr, that.cWindow,'','text');
    },
    cWindow : function(result){
        var resultStr = result;
        $('body').append(resultStr);
    },
    wClose : function(str){
        if(!str)str = K.Const.randStr;
        $(K.Const.boxID + str).remove();
    },
    setmsg : function(str,icon){
        if(icon){
            $(K.Const.msgID + ' span.icon').removeClass('no');
            $(K.Const.msgID + ' span.icon').addClass('ok');
        }else{
            $(K.Const.msgID + ' span.icon').removeClass('ok');
            $(K.Const.msgID + ' span.icon').addClass('no');
        }
        $(K.Const.msgID).css('display','block');
        $(K.Const.msgID + ' span.text').text(str);
    },
    sendMsg : function(){
        var url = 'expr.html';//K.Const.url + '?act=send_message';
        autoClose	= true;
        autoSend	= false;
        phoneNumber	= false;
        captcha		= $(K.Const.captchaID).val();
        expr_id		= $(K.Const.expr_idID).val();
        mobile		= $(K.Const.mobileID).val();
        type		= 'exprAddress'
        Sendurl		= "";
        content 	= $(K.Const.conID).val();
        var myreg = K.Const.mobileReg;
        K.Const.verify_img = $(K.Const.captchaImgID).attr('data-src');
        if(!myreg.test(mobile)){
            K.setmsg(K.Const.mobileMSG);
            $(K.Const.mobileID).focus();
            $(K.Const.captchaImgID).attr('src',K.Const.verify_img + "&rnd=" + new Date().getTime());
            return false;
        }else if( captcha == ''){
            K.setmsg(K.Const.verMSG);
            $(K.Const.captchaImgID).attr('src',K.Const.verify_img + "&rnd=" + new Date().getTime());
            return false;
        }/*else if(content == '' || content == 'undefined'){
         K.setmsg(K.Const.messageMSG);
         $(K.Const.captchaImgID).attr('src',K.Const.verify_img + "&rnd=" + new Date().getTime());
         return false;
         }*/
        $(K.Const.SendBtnID).attr('disabled','disabled');
        K.setmsg(K.Const.SendingMsg);
        var data = "autoClose=" + autoClose ;
        data += "&act=sendmsg";
        data += "&autoSend=" + autoSend ;
        data += "&captcha=" + captcha ;
        data += "&expr_id=" + expr_id ;
        data += "&mobile=" + mobile ;
        data += "&phoneNumber=" + phoneNumber ;
        data += "&type=" + type ;
        data += "&Sendurl=" + Sendurl ;
        data += "&content=" + content ;
        //K.SendSmsResult({error:0,message:'短信发送成功！'});
        K.ajax(url,data,K.SendSmsResult);
    },
    SendSmsResult : function (result){
        K.setmsg(result.message);
        if(result.error == 0){
            K.setmsg(result.message + K.Const.close3Msg,1);
            setTimeout(function(){K.wClose()}, 3000);
        }
        $(K.Const.SendBtnID).removeAttr('disabled');
        $(K.Const.captchaImgID).attr('src',K.Const.verify_img + "&rnd=" + new Date().getTime());
    },

    ajax : function(url,data,callback,parameters,datatype){
        if(datatype=='' || datatype==null)datatype='json';
        (data!="" && data!=null)?type="POST":type="GET";
        $.ajax({
            type:type,
            url:url,
            data:data,
            success:function(getdata){
                if(parameters!='' || parameters!=''){
                    callback(getdata,parameters);
                }else{
                    callback(getdata);
                }
            },
            error:function(e){
                K.setmsg("服务器连接失败！");
            },
            dataType:datatype
        });
    },
    rand : function(len){
        var str = "1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
        if(len < 2) len = 1;
        var tmp = "";
        for(var i=0;i < len;i++) {
            tmp += str.charAt(Math.ceil(Math.random()*100000000) % str.length);
        }
        return	tmp;
    }
}

Jiniu.passport = {
    init : function(box, $type){
        var obj = '';
        var that = Jiniu.passport;
        Jiniu.box = box;

        if ($type == 0) {
            obj = $('#JS_loginBtn', box);
            obj.val('登录');
            obj.bind('click', function(){that.login(box,this)});
            //$('#JS_mloginfrm').submit(function(){$('#JS_loginBtn', box).click()});
        } else {
            var tab = $('#JS_regType').find('input:checked');
            if (tab.val() == 0) {
                obj = $('#JS_registBtn', box);
                obj.val('立即注册');
                obj.unbind('clcik').bind('click', function(){that.register(box,this)});
            } else if (tab.val() == 1)  {
                obj = $('#JS_mregistBtn', box);
                obj.val('立即注册');
                obj.unbind('clcik').bind('click', function(){that.register(box,this)});
            } else {
                obj = $('#JS_registBtn', box);
                obj.val('立即注册');
                obj.unbind('clcik').bind('click', function(){that.register(box,this)});

                obj = $('#JS_mregistBtn', box);
                obj.val('立即注册');
                obj.unbind('clcik').bind('click', function(){that.register(box,this)});
                $('#JS_regType',box).find('input').get(0).click();
            }
            $('#JS_regType',box).find('input').attr('disabled',false);
        }
        obj.css('background','#ff4c4c');
        $('.input_text', box).bind('blur', function(){that.textblur(box, this)});
        that.regtype(box);
        that.getverify(box);
    },
    login : function(box,obj){
        $(obj).unbind('click');
        $(obj).val('正在登录....');
        $(obj).css('background','#ccc');
        var that = Jiniu.passport;
        var url = base_url + 'user.php?act=act_login';
        var loginbox    = $('.mlogin', box),
            user        = $('.username',loginbox),
            pass        = $('.password',loginbox),
            verify      = $('.verify',loginbox),
            autol       = $('.autologin',loginbox),
            back        = $('.backact',loginbox),
            autologin   = autol.checked ? 1 : 0;
        if (user.val() == '') {
            that.msg(user,1,'用户名不能为空！');
            that.init(box, 0);
        } else if ( pass.val().length < 6) {
            that.msg(pass,1,'密码不能小数6位数！');
            that.init(box, 0);
        } else if (verify.length > 0 && verify.val().length != 4) {
            that.msg(verify,1,'验证码输入错误！');
            that.init(box, 0);
        } else {
            var data = 'is_ajax=1';
            if (verify.length > 0) {
                data += '&captcha=' + verify.val();
            }
            data += '&username=' + user.val();
            data += '&password=' + pass.val();
            data += '&remember=' + autologin;
            data += '&back_act=' + back.val();
            Jiniu.ajax(url,data,that.loginResult,'POST','JSON');
        }
    },
    textblur : function(box,obj){
        Jiniu.passport.unmsg(box,obj);
    },
    loginResult : function(result){
        var that = Jiniu.passport;
        if (result.error != 0) {
            alert(result.message);
            that.init(Jiniu.box, 0);
        } else {
            if (result.lnk) {
                location.href = result.lnk;
            } else {
                location.reload();
            }
        }
    },
    getverify : function(box){
        var that = Jiniu.passport;
        var obj = $('#JS_nregist', box);
        var getv = function(){

        }
        $('#JS_getVer', obj).unbind('click').bind('click', function(){
            var tel = $('.mobile', obj).val()
            var ss = $(this);
            var str = '获取验证码';
            ss.unbind('click');
            if (!Jiniu.checkMobile(tel)) {
                that.msg($('.mobile', obj),1,'请输入正确的手机号码！');
                that.init(box, 1);
            } else {
                var time = 180;
                var data = 'tel=' + tel;
                var step = function(){
                    time = time - 1;
                    if (time > 0) {
                        ss.text(str + '(' + time + ')');
                        setTimeout(step,1000);
                    } else {
                        ss.text(str);
                        that.getverify(Jiniu.box);
                        time = 180;
                    }
                };
                var result = function(ex){
                    if (ex.error > 0) {
                        alert(ex.message);
                    } else {
                        alert(ex.message);
                        step();
                    }
                }
                Jiniu.ajax('/sendmessage.php?act=send', data, result, 'POST', 'JSON');
            }
        });
    },
    regtype : function(box){
        $('#JS_regType', box).find('input').bind('change', function(){
            var context = $(this).attr('data-context');
            box.find('ul.mregist').addClass('none');
            $(context,box).removeClass('none');
        });
    },
    register : function(box,obj){
        var btn = $(obj);
        var $typeobj = $('#JS_regType',box);
        var $type = $typeobj.find('input:checked').val();
        $typeobj.find('input').attr('disabled',true);
        btn.unbind();
        btn.val('正在提交注册....');
        btn.css('background','#ccc');
        var that = Jiniu.passport;
        if ($type === "0") {
            var registbox = $('#JS_mregist', box),
                userobj = $('.username', registbox),
                emailobj = $('.email', registbox),
                pass1obj = $('.pass1', registbox),
                pass2obj = $('.pass2', registbox),
                mobileobj = $('.mobile', registbox),
                protocolobj = $('.protocol', registbox),
                backobj = $('.backact', registbox);
            var user = userobj.val(),
                email = emailobj.val(),
                pass1 = pass1obj.val(),
                pass2 = pass2obj.val(),
                mobile = mobileobj.val(),
                protocol = (protocolobj.is(':checked') ? 1 : 0);
            if (!Jiniu.checkUser(user)) {
                that.msg(userobj,1,'用户名必须为字母加数字加下划线组合！');
                that.init(box, 1);
            } else if (!Jiniu.checkEmail(email)) {
                that.msg(emailobj,1,'请输入正确的Email地址！');
                that.init(box, 1);
            } else if (pass1.length < 6 || pass1.length > 18) {
                that.msg(pass1obj,1,'密码密码为6-18字符串！');
                that.init(box, 1);
            } else if (pass1 != pass2) {
                that.msg(pass2obj,1,'两次密码输入不一致！');
                that.init(box, 1);
            } else if (!Jiniu.checkMobile(mobile)) {
                that.msg(mobileobj,1,'请输入正确的手机号码！');
                that.init(box, 1);
            } else if (protocol != 1) {
                alert('同意美家家商城注册协议方可继续注册！');
                that.init(box, 1);
            } else {
                var url = base_url + 'user.php?act=act_register&is_ajax=1';
                var data = 'username=' + user;
                data += '&password=' + pass1;
                data += '&confirm_password=' + pass2;
                data += '&email=' + email;
                data += '&extend_field5=' + mobile;
                data += '&agreement=' + protocol;
                data += '&type=' + $type;
                data += '&back_act=' + backobj.val();
                Jiniu.ajax(url,data,that.registerResult,'POST','JSON');
            }
        } else {
            var registbox = $('#JS_nregist', box),
                mobileobj = $('.mobile', registbox),
                verifyobj = $('.verify', registbox),
                pass1obj = $('.password', registbox),
                pass2obj = $('.password1', registbox),
                userobj = $('.username', registbox),
                protocolobj = $('.protocol', registbox),
                backobj = $('.backact', registbox);
            var mobile = mobileobj.val(),
                verify = verifyobj.val(),
                pass1 = pass1obj.val(),
                pass2 = pass2obj.val(),
                user = userobj.val(),
                protocol = (protocolobj.is(':checked') ? 1 : 0);
            if (!Jiniu.checkMobile(mobile)) {
                that.msg(mobileobj,1,'请输入正确的手机号码！');
                that.init(box, 1);
            } else if (verify.length != 6) {
                that.msg(verifyobj,1,'请输入手机收到的验证码！');
                that.init(box, 1);
            } else if (pass1.length < 6 || pass1.length > 18) {
                that.msg(pass1obj,1,'密码密码为6-18字符串！');
                that.init(box, 1);
            } else if (pass1 != pass2) {
                that.msg(pass2obj,1,'两次密码输入不一致！');
                that.init(box, 1);
            } else if (protocol != 1) {
                alert('同意美家家商城注册协议方可继续注册！');
                that.init(box, 1);
            } else {
                var url = base_url + 'user.php?act=act_register&is_ajax=1';
                var data = 'username=' + mobile;
                data += '&verify=' + verify;
                data += '&password=' + pass1;
                data += '&confirm_password=' + pass2;
                data += '&email=' + email;
                data += '&type=' + $type;
                data += '&extend_field5=' + mobile;
                data += '&agreement=' + protocol;
                data += '&back_act=' + backobj.val();
                Jiniu.ajax(url,data,that.registerResult,'POST','JSON');
            }
            $typeobj.find('input').attr('disabled',false);
        }
    },
    registerResult : function(result){
        var box = this.box,
            that = Jiniu.passport;
        if (result.error > 0) {
            if (result.field) {
                that.msg($('.' + result.field, box),1,result.message);
            } else {
                alert(result.message);
            }
            that.init(Jiniu.box, 1);
        } else {
            if (result.lnk) {
                location.href = result.lnk;
            } else {
                location.href = '/';
            }
        }
        //Jiniu.passport.bindevent($('#JS_registBtn'), 1);
    },
    msg : function(obj, $type, $msg){
        obj.parent().children('.msg').text($msg);
        if ($type == 0) {
            $(obj).parent().addClass('success');
        } else {
            $(obj).parent().addClass('error');
        }
    },
    unmsg : function(box,obj){
        var o = $(obj,box).parent();
        if (o.hasClass('error')) {
            o.removeClass('error');
        }
        if (o.hasClass('success')) {
            o.removeClass('success');
        }
    }
}


Jiniu.login = function(){
    var that = this;
    var box = '';
    that.msgbox('','登录页面加载中.....');
    var loginResult = function(data){
        that.close_msgbox();
        box = that.msgbox(data,'用户登录','',400,500);
        that.passport.init(box, 0);
    };
    var url = base_url + 'user.php?act=mlogin';
    that.ajax(url, '', loginResult, 'POST', 'HTML');
}
Jiniu.regist = function(){
    var that = this;
    var box = '';
    that.msgbox('','注册页面加载中.....');
    var registResult = function(data){
        that.close_msgbox();
        box = that.msgbox(data,'用户注册','',400,560);
        that.passport.init(box, 1);
    };
    var url = base_url + 'user.php?act=mregister';
    that.ajax(url, '', registResult, 'POST', 'HTML');
}

Jiniu.getCartNum = function(){
    var url = '/flow.html?step=get_cart_num';
    var obj = $('#JS_top_Cart_num');
    var res = function(ex){
        if (ex.error > 0) {
            //alert(ex.message);
        } else {
            obj.text(ex.contents.goods_number);
        }
    };
    Jiniu.ajax(url,'id=', res, 'GET', 'JSON');
}






$.fn.extend({
    HsetScrollx: function () {   //设置超出滚动  默认选取ul
        this.each(function () {
            $(this).css('position', 'relative');
            var linum = $(this).find('li');
            for (var i = 0; i < linum.length; i++) {
                var w = linum.eq(0).width();
                linum.eq(i).css({'position': 'absolute', 'left': w * i});
            }
        })
    },
    HsetIndex: function () {          //点击切换选中功能
        this.each(function () {
            var li = $(this).find('li');
            for (var i = 0; i < li; i += 1) {
                if (i == 0) {
                    $(this[0]).addClass('cur');
                } else
                    this.addClass('cur').siblings().removeClass('cur');
            }
        })
    },
    HsetHeight: function (callback) {       //设置高度填满屏幕高度
        this.each(function () {
            var e = $(window).height() - $(this).offset().top;
            var rem = hkhp.Hrem(e);
            $(this).css({'height': rem, 'overflow': 'scroll'});
            callback && callback(rem);
        });
    },
    HscrollButtom: function (callback) {
        $(this).bind('scroll',function(){
            $(this).each(function () {
                if (this == window) {
                    //解决html5和W3C文档的兼容性
                    var scrollTop = window.pageYOffset  //用于FF
                        || document.documentElement.scrollTop
                        || document.body.scrollTop;
                    var clientHeight = document.documentElement.clientHeight
                        || document.body.clientHeight;
                    var scrollHeight = document.documentElement.scrollHeight
                        || document.body.scrollHeight;
                    if (((scrollTop + clientHeight) / scrollHeight) >= 1) callback();
                } else {
                    if (this.offsetHeight + this.scrollTop >= this.scrollHeight) callback();
                }
            });
        });
    },
    HscrollTop: function(callback1,callback2,callback3) {
        $(this).on("touchstart", function (e) {
            e.preventDefault();
            startX = e.originalEvent.changedTouches[0].pageX,
                startY = e.originalEvent.changedTouches[0].pageY;
            callback1&&callback1(startX,startY);
        });
        $(this).on("touchmove", function (e) {
            e.preventDefault();
            moveEndX = e.originalEvent.changedTouches[0].pageX,
                moveEndY = e.originalEvent.changedTouches[0].pageY;
            callback2&&callback2(moveEndX,moveEndY);
        });
        $(this).on("touchend", function () {
            callback3&&callback3(moveEndX,moveEndY);
        });
    }
})

/*var __sto = setInterval;
window.setInterval = function(callback,timeout,param){
    var args = Array.prototype.slice.call(arguments,2);
    var _cb = function(){
        callback.apply(null,args);
    }
    __sto(_cb,timeout);
}
window.setInterval(hello,3000,userName);*/

var hkhp = {
    Hrem:function(rs) {        //像素转换rem
        return (rs / ($(window).width() / 10)) + 'rem';
    },
    Hajax:function(info) {
        var page = 1,json = function(callback){
            $(window).unbind('scroll');
            $('.list_botton').html('<span><img src="/Public/Wap/images/loading1.gif" /></span><span>加载中....</span>');
            Jiniu.ajax(info.url+ page, '',function(ex){
                if(ex.error == 200){
                    page = ex.data.curpage + 1;
                    info.textwarp.append(ex.data.str);
                    if (ex.data.curpage >= ex.data.pagecount ) {
                        $('.list_botton').text('后面没有了！');
                    }
                    else{
                        $(window).bind('scroll',scroll);
                        $('.list_botton').text('上拉加载更多店铺！');
                    }
                }else  alert(ex.msg);
            },'POST','JSON');
        },scroll = function(){
            info.scrollobj.HscrollButtom(function(){
                json();
            })
        };
        info.scrollobj.bind('scroll',json);
    },
    scrollajax:function(info){
        $('.list_botton').html('<span><img src="/Public/Wap/images/loading1.gif" /></span><span>加载中....</span>');
        Jiniu.ajax(info.url+ page, '',function(ex){
            if(ex.error == 200){
                /*page = ex.data.curpage + 1;*/
                info.textwarp.append(ex.data.str);
                if (ex.data.curpage >= ex.data.pagecount ) {
                    $('.list_botton').text('后面没有了！');
                }
                else{
                    $('.list_botton').text('上拉加载更多店铺！');
                }
            }else  alert(ex.msg);
        },'POST','JSON');
    },
    outTime:function(end,$d,$h,$m,$s){
        var newTime = Date.parse(new Date()) /1000;
        var t = end -newTime;

        var t = end -newTime;
        var checkTime = function(i) {
            if (i < 10) i = "0" + i;
            return i;
        };
        if (t > 0) {
        d = checkTime(Math.floor(t/3600/24));
            h = checkTime(Math.floor(t/3600%24));
            m = checkTime(Math.floor(t/60%60));
            s = checkTime(Math.floor(t%60));
            $d.text(d);$h.text(h);$m.text(m);$s.text(s);
        }else {
            $d.text('00');$h.text('00');$m.text('00');$s.text('00');
        }
    }
};
$.fn.autoHeight = function(){
    function autoHeight(elem){
        elem.style.height = 'auto';
        elem.scrollTop = 0; //防抖动
        elem.style.height = elem.scrollHeight + 'px';
    }
    this.each(function(){
        autoHeight(this);
        $(this).on('keyup click', function(){
            autoHeight(this);
        });
    });
}
